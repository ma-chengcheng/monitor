<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>控制台-八爪鱼</title>

    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/icomoon.css">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/flexslider.css">

    <link rel="stylesheet" href="css/style.css">

    <script src="js/modernizr-2.6.2.min.js"></script>

</head>

<body>

<div class="fh5co-loader"></div>

<div id="page">
    <nav class="fh5co-nav" role="navigation">
        <div class="top-menu">
            <div class="container">
                <div class="row">
                    <div class="col-xs-2">
                        <div id="fh5co-logo"><a href="index.html">八爪鱼</a></div>
                    </div>
                    <div class="col-xs-10 text-right menu-1">
                        <ul>
                            <li><a href="index.html">首页</a></li>
                            <li class="active"><a href="#">控制台</a></li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </nav>

    <header id="fh5co-header" class="fh5co-cover js-fullheight" role="banner">
        <div class="overlay"></div>
        <div class="container">

            <div class="row animate-box">
                <div class="col-xs-4 text-left fh5co-heading fh5co-nav top-menu menu-1">
                    <ul>
                        <li class="active"><a href="#">资源概述</a></li>
                    </ul>
                </div>
                <div class="col-xs-offset-4 col-xs-4 text-right">
                    <a class="btn btn-success btn-sm btn-learn" href="add_server.html">添加主机</a>
                </div>
            </div>

            <div class="row">
                <div v-for="worker in workers" class="col-md-6">
                    <div class="fh5co-blog animate-box">
                        <div class="blog-text">
                            <h2><a href="/blog/technology/gRPC.html">{{worker.name}}</a></h2>
                            <div class="row">
                                <div class="col-xs-6">
                                    <span class="posted_on">IP <b>{{worker.ip}}</b></span>
                                </div>
                                <div class="col-xs-6 text-right">
                                    <span class="posted_on text-right" style="color: green;">运行中</span>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-xs-4">
                                    <h5>cpu使用率</h5>
                                </div>
                                <div class="col-xs-4">
                                    <h5>内存使用率</h5>
                                </div>
                                <div class="col-xs-4">
                                    <h5>磁盘使用率</h5>
                                </div>
                            </div>


                            <div class="row text-center">
                                <div class="col-xs-4">
                                    <h2>{{worker.cpu}}%</h2>
                                </div>
                                <div class="col-xs-4">
                                    <h2>{{worker.mem}}%</h2>
                                </div>
                                <div class="col-xs-4">
                                    <h2>{{worker.disk}}%</h2>
                                </div>
                            </div>

                            <ul class="stuff text-right">
                                <a href="#" class="btn btn-sm btn-info">详情</a>
                                <a v-on:click="deleteNode(worker.ip)" class="btn btn-sm btn-danger">删除</a>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

</div>

<div class="gototop js-top">
    <a href="#" class="js-gotop"><i class="icon-arrow-up22"></i></a>
</div>

<!-- jQuery -->
<script src="js/jquery.min.js"></script>
<!-- jQuery Easing -->
<script src="js/jquery.easing.1.3.js"></script>
<!-- Bootstrap -->
<script src="js/bootstrap.min.js"></script>
<!-- Waypoints -->
<script src="js/jquery.waypoints.min.js"></script>
<!-- Flexslider -->
<script src="js/jquery.flexslider-min.js"></script>
<!-- Main -->
<script src="js/main.js"></script>
<!-- Vue -->
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<!-- Axios -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    new Vue({
        el: '#page',
        data: {
            workers: [
                {
                    name: 'aliserver_1',
                    ip: '127.0.0.1',
                    cpu: '20',
                    mem: '32',
                    disk: '11'
                }
            ]
        },
        created() {
            this.initWebSocket();
        },
        destroyed() {
            this.websock.close() //离开路由之后断开websocket连接
        },
        methods: {
            initWebSocket() { //初始化weosocket
                const wsuri = "ws://127.0.0.1:8081/api/v1/ws/query";
                this.websock = new WebSocket(wsuri);
                this.websock.onmessage = this.websocketonmessage;
                this.websock.onopen = this.websocketonopen;
                this.websock.onerror = this.websocketonerror;
                this.websock.onclose = this.websocketclose;
            },
            websocketonopen() { //连接建立之后执行send方法发送数据
                let actions = {"test": "12345"};
                this.websocketsend(JSON.stringify(actions));
            },
            websocketonerror() {//连接建立失败重连
                this.initWebSocket();
            },
            websocketonmessage(e) { //数据接收
                const reciveData = JSON.parse(e.data);
                this.workers = reciveData.NodeInfos
            },
            websocketsend(Data) {//数据发送
                this.websock.send(Data);
            },
            websocketclose(e) {  //关闭
                console.log('断开连接', e);
            },
            deleteNode (ip) {
                console.log(ip);

                axios.post('/api/v1/delete_node', {
                    ip: this.IP,
                }).then(function (response) {
                    console.log(response);
                })
                .catch(function (error) {
                    console.log(error);
                });
            }
        },
    })
</script>
</body>

</html>